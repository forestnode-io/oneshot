"use strict";(()=>{var p=16384;var n=1*p;var e=8*p;var b="boundary";async function r(e,n,t){console.log("writeHeader: ",n,t);const o=(t==null?void 0:t.method)||"GET";let r=`${o} ${n} HTTP/1.1
`;let s=(t==null?void 0:t.headers)?t.headers:new Headers;if(s instanceof Headers){if(!s.has("User-Agent")){s.append("User-Agent",navigator.userAgent)}s.forEach((e,n)=>{r+=`${n}: ${e}
`})}else if(typeof s==="object"){if(s instanceof Array){var i=false;for(var a=0;a<s.length;a++){r+=`${s[a][0]}: ${s[a][1]}
`;if(s[a][0]==="User-Agent"){i=true}}if(!i){r+=`User-Agent: ${navigator.userAgent}
`}}else{if(!s["User-Agent"]){s["User-Agent"]=navigator.userAgent}for(const u in s){r+=`${u}: ${s[u]}
`}}}r+="\n";var c=void 0;var l=void 0;var f=new Promise((e,n)=>{c=e;l=n});const d=h(e,c,r);d();return f}function h(n,t,o){var r=p;const s=function(){while(o.length){if(n.bufferedAmount>n.bufferedAmountLowThreshold){n.onbufferedamountlow=()=>{n.onbufferedamountlow=null;s()}}if(o.length<r){r=o.length}const e=o.slice(0,r);o=o.slice(r);n.send(e);if(r!=p){t();return}}};return s}async function s(e,n){if(!n){e.send(new Uint8Array(0));e.send("");return Promise.resolve()}var t=void 0;var o=void 0;var r=void 0;var s=new Promise((e,n)=>{o=e;r=n});if(n instanceof ReadableStream){const a=await n.getReader().read();n=a.value}else{if(n instanceof FormData){l(e,n).then(()=>{o()});return s}else if(n instanceof Blob){t=await n.arrayBuffer()}else if(n instanceof URLSearchParams){t=(new TextEncoder).encode(n.toString())}else if(typeof n==="string"){t=(new TextEncoder).encode(n)}else if(n instanceof ArrayBuffer){t=n}}const i=c(e,t,o);i();return s}function c(n,t,o){var r=p;const s=function(){while(t.byteLength){if(n.bufferedAmount>n.bufferedAmountLowThreshold){n.onbufferedamountlow=()=>{n.onbufferedamountlow=null;s()}}if(t.byteLength<r){r=t.byteLength}const e=t.slice(0,r);t=t.slice(r);n.send(e);if(r!=p){n.send("");if(o)o();return}}};return s}async function l(u,h){const w=new TextEncoder;return new Promise(async(e,n)=>{for(const i of h.entries()){var t=`--${b}
`;const a=i[0];const c=i[1];if(typeof c==="string"){t+=`Content-Disposition: form-data; name="${a}"

`;u.send(w.encode(t));u.send(w.encode(c))}else{const l=c;t+=`Content-Disposition: form-data; name="${a}"; filename="${l.name}"
`;if(l.type){t+=`Content-Type: ${l.type}

`}else{t+="Content-Type: application/octet-stream\n\n"}u.send(w.encode(t));var o;var r=new Promise((e,n)=>{o=e});const f=new FileReader;var s=0;f.onerror=e=>{console.log("Error reading file",e)};f.onabort=e=>{console.log("File reading aborted",e)};f.onload=e=>{const n=e.target.result;u.send(n);s+=n.byteLength;if(s<l.size){d(s)}else{o()}};const d=e=>{f.readAsArrayBuffer(l.slice(e,e+p))};d(s);await r}}u.send(w.encode(`
--${b}--
`));u.send("");e()})}function v(e){const n=e.split("\n");const t={};for(const o of n){const r=o.search(":");if(r===-1){continue}const s=o.slice(0,r);const i=o.slice(r+1);t[s]=i.trim()}return t}function T(e){if(!e.startsWith("HTTP/1.1")){throw new Error(`unexpected status line: ${e}`)}const n=e.split(" ");if(n.length<3){throw new Error(`unexpected status line: ${e}`)}const t=parseInt(n[1]);const o=n.slice(2).join(" ");return{status:t,statusText:o}}function o(m,y){m.bufferedAmountLowThreshold=n;m.binaryType="arraybuffer";let e=(e,n,l)=>{var f=()=>{};var t=()=>{};const o=new Promise((e,n)=>{f=e;t=n});var d="";var u=-1;var h="";var w={};const p=new MessageChannel;var g=[];m.onmessage=o=>{if(o.data instanceof ArrayBuffer){if(u===-1){const r=d.slice(0,d.search("\n"));d=d.slice(d.search("\n")+1);const s=T(r);u=s.status;h=s.statusText;w=v(d);d="";g.push(o.data);p.port1.postMessage(null);const i=new Headers;for(const a in w){i.append(a,w[a])}if(i.has("Content-Length")&&l){const c=parseInt(i.get("Content-Length"));l(-1,c)}if(y){i.append("X-HTTPOverWebRTC-Authorization",y)}let e={status:u,statusText:h,headers:i};let n=new ReadableStream({type:"bytes",start(e){if(e instanceof ReadableByteStreamController){if(e.byobRequest){throw new Error("byobRequest not supported")}}},pull(r){return new Promise((o,e)=>{p.port2.onmessage=e=>{const n=g.shift();if(!n){m.send("");r.close();o();l==null?void 0:l(0);return}const t=n.byteLength;r.enqueue(new Uint8Array(n));o();l==null?void 0:l(t)}})}});let t=new Response(n,e);f(t)}else{const e=o.data;if(0<e.byteLength){g.push(e);p.port1.postMessage(null)}}}else if(typeof o.data==="string"){if(u===-1){d+=o.data}else{p.port1.postMessage(null)}}};if((n==null?void 0:n.body)instanceof FormData){if(!n.headers){n.headers=new Headers}if(n.headers instanceof Headers){n.headers.append("Content-Type","multipart/form-data; boundary="+b)}else if(typeof n.headers==="object"){if(n.headers instanceof Array){n.headers.push(["Content-Type","multipart/form-data; boundary="+b])}else{n.headers["Content-Type"]="multipart/form-data; boundary="+b}}}r(m,e,n).then(()=>{s(m,n==null?void 0:n.body).catch(e=>{t(e)})}).catch(e=>{t(e)});return o};return e}function m(e){var n;if(e instanceof HTMLScriptElement){(n=e.parentNode)==null?void 0:n.replaceChild(i(e),e)}else{var t=-1,o=e.childNodes;while(++t<o.length){m(o[t])}}}function i(e){var n=document.createElement("script");n.text=e.innerHTML;var t=-1,o=e.attributes,r;while(++t<o.length){n.setAttribute((r=o[t]).name,r.value)}return n}function y(e,n){const t=document.createElement("a");t.setAttribute("style","display: none");document.body.appendChild(t);const o=new Blob([e],{type:"stream/octet"});const r=window.URL.createObjectURL(o);t.href=r;t.download=n;t.click();window.URL.revokeObjectURL(r)}var C=/^text\/.*$/;async function t(e,n,t=fetch){const o=document.createElement("span");document.body.innerHTML="";document.body.appendChild(o);var r=0;var s=0;const i=(e,n)=>{if(e===-1&&n){r=n}else if(0<e){s+=e;if(r){const t=(s/r*100).toFixed(2);o.innerText=`receiving data: ${t}%`}else{o.innerText=`receiving data: ${s} bytes`}}else{o.innerText=`receiving data: done`}return Promise.resolve()};const a=t;var c=await a(e,n,i);const l=c.headers;var f=l.get("Content-Type")?l.get("Content-Type"):"";f=f.split(";")[0];var d=l.get("Content-Disposition")?l.get("Content-Disposition"):"";if(!f){f="text/plain"}const u=P(d);if(u){const h=await c.blob();y(h,u);return}if(f.match(C)){const w=await c.text();if(f==="text/html"){const p=new DOMParser;const g=p.parseFromString(w,"text/html");document.body=g.body;m(document.body)}else{document.body.innerText=w;document.body.innerHTML=`<pre>${w}</pre>`}}else if(f.startsWith("application/")){const w=await c.blob();let e=new Blob([w],{type:f});let n=URL.createObjectURL(e);window.open(n,"_self")}else{console.log(`falling back to displaying body as preformatted text`);const w=await c.text();document.body.innerText=w;document.body.innerHTML=`<pre>${w}</pre>`}}function P(e){if(!e||!e.includes("attachment")){return""}const n=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;const t=n.exec(e);if(t!=null&&t[1]){return t[1].replace(/['"]/g,"")}return""}var a=class{constructor(e,n){this.answered=false;this.connectionPromiseResolve=()=>{};this.connectionPromiseReject=()=>{};this.resolveAnswerPromise=()=>{};this.rejectAnswerPromise=()=>{};this.answerPromise=new Promise((e,n)=>{this.resolveAnswerPromise=e;this.rejectAnswerPromise=n});this.peerConnection=new RTCPeerConnection(e);if(n){this.baToken=n}this.connectionPromise=new Promise((e,n)=>{this.connectionPromiseResolve=e;this.connectionPromiseReject=n});this._configurePeerConnection()}_configurePeerConnection(){const t=this.peerConnection;t.onicegatheringstatechange=e=>{console.log("onicegatheringstatechange",t.iceGatheringState);let n=e.target;if(n.iceGatheringState==="complete"&&n.localDescription){this.resolveAnswerPromise(n.localDescription)}};t.ondatachannel=e=>{console.log("ondatachannel",e);this._fetch=o(e.channel,this.baToken);window.fetch=this._fetch;window.rtcReady=true;this.connectionPromiseResolve()};t.onnegotiationneeded=e=>{console.log("onnegotiationneeded")};t.onsignalingstatechange=e=>{console.log("onsignalingstatechange",t.signalingState)};t.oniceconnectionstatechange=e=>{console.log("oniceconnectionstatechange",t.iceConnectionState)};t.onicecandidate=e=>{console.log("onicecandidate",e)}}answerOffer(e){if(this.answered){return{Answer:Promise.reject("already answered"),ConnectionEstablished:Promise.reject("already answered")}}const n=this.peerConnection;const t=e=>{n.setLocalDescription(e).then(()=>{this.answered=true;this.resolveAnswerPromise(new RTCSessionDescription(e))})};n.setRemoteDescription(e).then(()=>n.createAnswer().then(t)).catch(e=>{console.error(e);this.rejectAnswerPromise(e);this.connectionPromiseReject(e)});return{Answer:this.answerPromise,ConnectionEstablished:this.connectionPromise}}fetch(e,n){if(!this._fetch){return Promise.reject("HTTPOverWebRTC fetch not ready")}return this._fetch(e,n)}visit(e,n){if(!this._fetch){return Promise.reject("HTTPOverWebRTC fetch not ready")}return t(e,n,this._fetch.bind(this))}connected(){return this._fetch!==void 0}};function f(n,t){return e=>{fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({SessionID:t,Answer:e.sdp})}).then(e=>{if(e.status!==200){alert("failed to send answer: "+e.status+" "+e.statusText)}}).catch(e=>{alert(`failed to send answer: ${e}`)})}}function d(e){const n=JSON.stringify(e);const t=document.getElementById("answer-container");if(t){t.innerText=n}navigator.clipboard.writeText(n)}function u(e){if(!e.offer){alert("no offer");return}const n=new a(e.rtcConfig,e.baToken);const t=n.answerOffer(e.offer);t.ConnectionEstablished.then(()=>n.visit("/",{}));t.Answer.then(e.onAnswer)}window.WebRTCClient=a;function w(){let e={credentials:"same-origin",method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json","X-Session-Token":window.sessionToken}};return fetch(window.location.href,e).then(e=>{if(e.status!==200){throw new Error("failed to fetch config: "+e.status+" "+e.statusText)}return e.json()}).then(e=>{if(!e.RTCSessionDescription||!e.RTCConfiguration||!e.SessionID){throw new Error("failed to fetch config: invalid json")}return e}).catch(e=>{throw new Error(`failed to fetch config: ${e}`)})}async function g(){const n=document.getElementById("connect-button");if(n){try{let e=await A(false);n.onclick=()=>{try{u(e)}catch(e){alert(e);return}}}catch(e){alert(e);return}}else{const e=document.createElement("span");e.innerText="tunnelling to oneshot server...";document.body.appendChild(e);try{let e=await A(true);console.log("got connection config: ",e);u(e)}catch(e){alert(e);return}}}async function A(n){let t={};try{let e=await w();t.rtcConfig=e.RTCConfiguration;t.offer=e.RTCSessionDescription;t.sessionID=e.SessionID;t.endpoint=window.location.href;t.baToken=window.basicAuthToken;if(n){t.onAnswer=f(t.endpoint,t.sessionID)}else{t.onAnswer=d}}catch(e){alert(e);return Promise.reject(e)}return t}g()})();