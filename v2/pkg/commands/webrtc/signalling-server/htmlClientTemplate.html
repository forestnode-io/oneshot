<!DOCTYPE html>
<html>
<head></head>
<body>
    <div id="answer-component">
        <label for="ice-server-url">ICE Server URL</label><br>
        <input type="text" id="ice-server-url" value="stun:stun.l.google.com:19302"><br>
        <br>
        <label for="server-sd">Oneshot Session Offer</label><br>
        <textarea id="server-sd" rows="10" cols="50"></textarea><br>
        <br>
        <label for="httpRequest">HTTP Request (optional)</label><br>
        <textarea id="httpRequest" rows="10" cols="50"></textarea><br>
        <br>
        <button type="button" id="connect-button">Generate Answer & Copy to Clipboard</button><br>
        <div id="answer-container">
            <span id="answer-span"></span>
        </div>
    </div>
</body>
<footer>
    <script>
    "use strict";(()=>{function d(e){var n;if(e instanceof HTMLScriptElement){(n=e.parentNode)==null?void 0:n.replaceChild(r(e),e)}else{var t=-1,o=e.childNodes;while(++t<o.length){d(o[t])}}}function r(e){var n=document.createElement("script");n.text=e.innerHTML;var t=-1,o=e.attributes,r;while(++t<o.length){n.setAttribute((r=o[t]).name,r.value)}return n}function u(e,n){const t=document.createElement("a");t.setAttribute("style","display: none");document.body.appendChild(t);const o=new Blob([e],{type:"stream/octet"});const r=window.URL.createObjectURL(o);t.href=r;t.download=n;t.click();window.URL.revokeObjectURL(r)}var f=/^text\/.*$/;async function c(e,n){var t=await fetch(e,n);const o=t.headers;var r=o.get("Content-Type")?o.get("Content-Type"):"";r=r.split(";")[0];var s=o.get("Content-Disposition")?o.get("Content-Disposition"):"";if(!r){r="text/plain"}const a=h(s);if(a){console.log(`triggering download of ${a}`);u(t.body,a);return}const i=await t.text();if(r.match(f)){if(r==="text/html"){const c=new DOMParser;const l=c.parseFromString(i,"text/html");document.body=l.body;d(document.body)}else{document.body.innerText=i;document.body.innerHTML=`<pre>${i}</pre>`}}else{console.log(`falling back to displaying body as preformatted text`);document.body.innerText=i;document.body.innerHTML=`<pre>${i}</pre>`}}function h(e){if(!e||!e.includes("attachment")){return""}const n=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;const t=n.exec(e);if(t!=null&&t[1]){return t[1].replace(/['"]/g,"")}return""}var m=16384;var e=1*m;var n=8*m;var p="boundary";async function s(e,n,t){console.log("writeHeader: ",n,t);const o=(t==null?void 0:t.method)||"GET";let r=`${o} ${n} HTTP/1.1
`;if(t==null?void 0:t.headers){if(t.headers instanceof Headers){t.headers.forEach((e,n)=>{r+=`${n}: ${e}
`})}else if(typeof t.headers==="object"){if(t.headers instanceof Array){for(var s=0;s<t.headers.length;s++){r+=`${t.headers[s][0]}: ${t.headers[s][1]}
`}}else{for(const d in t.headers){r+=`${d}: ${t.headers[d]}
`}}}}r+="\n";var a=void 0;var i=void 0;var c=new Promise((e,n)=>{a=e;i=n});const l=g(e,a,r);l();return c}function g(n,t,o){var r=m;const s=function(){while(o.length){if(n.bufferedAmount>n.bufferedAmountLowThreshold){n.onbufferedamountlow=()=>{n.onbufferedamountlow=null;s()}}if(o.length<r){r=o.length}const e=o.slice(0,r);o=o.slice(r);n.send(e);if(r!=m){t();return}}};return s}async function a(e,n){if(!n){return Promise.resolve()}var t=void 0;var o=void 0;var r=void 0;var s=new Promise((e,n)=>{o=e;r=n});if(n instanceof ReadableStream){const i=await n.getReader().read();n=i.value}else{if(n instanceof FormData){v(e,n).then(()=>{o()});return s}else if(n instanceof Blob){t=await n.arrayBuffer()}else if(n instanceof URLSearchParams){t=(new TextEncoder).encode(n.toString())}else if(typeof n==="string"){t=(new TextEncoder).encode(n)}else if(n instanceof ArrayBuffer){t=n}}const a=l(e,t,o);a();return s}function l(n,t,o){var r=m;const s=function(){while(t.byteLength){if(n.bufferedAmount>n.bufferedAmountLowThreshold){n.onbufferedamountlow=()=>{n.onbufferedamountlow=null;s()}}if(t.byteLength<r){r=t.byteLength}const e=t.slice(0,r);t=t.slice(r);n.send(e);if(r!=m){if(o)o();return}}};return s}async function v(f,h){const g=new TextEncoder;return new Promise(async(e,n)=>{for(const a of h.entries()){var t=`--${p}
`;const i=a[0];const c=a[1];if(typeof c==="string"){t+=`Content-Disposition: form-data; name="${i}"

`;f.send(g.encode(t));f.send(g.encode(c))}else{const l=c;t+=`Content-Disposition: form-data; name="${i}"; filename="${l.name}"
`;if(l.type){t+=`Content-Type: ${l.type}

`}else{t+="Content-Type: application/octet-stream\n\n"}f.send(g.encode(t));var o;var r=new Promise((e,n)=>{o=e});const d=new FileReader;var s=0;d.onerror=e=>{console.log("Error reading file",e)};d.onabort=e=>{console.log("File reading aborted",e)};d.onload=e=>{const n=e.target.result;f.send(n);s+=n.byteLength;if(s<l.size){u(s)}else{o()}};const u=e=>{d.readAsArrayBuffer(l.slice(e,e+m))};u(s);await r}}f.send(g.encode(`
--${p}--
`));f.send("EOF");e()})}function w(e){const n=e.split("\n");const t={};for(const o of n){const r=o.search(":");if(r===-1){continue}const s=o.slice(0,r);const a=o.slice(r+1);t[s]=a.trim()}return t}function y(e){if(!e.startsWith("HTTP/1.1")){throw new Error(`unexpected status line: ${e}`)}const n=e.split(" ");if(n.length<3){throw new Error(`unexpected status line: ${e}`)}const t=parseInt(n[1]);const o=n.slice(2).join(" ");return{status:t,statusText:o}}function o(r){r.bufferedAmountLowThreshold=e;return(e,n)=>{var l=()=>{};var t=()=>{};const o=new Promise((e,n)=>{l=e;t=n});var d="";var u=-1;var f="";var h={};let g=new MessageChannel;var m=[];r.onmessage=async r=>{if(r.data instanceof Blob){if(u===-1){const a=d.slice(0,d.search("\n"));d=d.slice(d.search("\n")+1);const i=y(a);u=i.status;f=i.statusText;h=w(d);d="";let e=await r.data.arrayBuffer();m.push(e);g.port1.postMessage(null);var s=new Headers;for(const c in h){s.append(c,h[c])}let n={status:u,statusText:f,headers:s};let t=new ReadableStream({type:"bytes",start(e){if(e instanceof ReadableByteStreamController){if(e.byobRequest){throw new Error("byobRequest not supported")}}},pull(o){return new Promise((t,e)=>{g.port2.onmessage=e=>{const n=m.shift();if(!n){o.close();t();return}o.enqueue(new Uint8Array(n));t()}})}});let o=new Response(t,n);l(o)}else{const n=r.data;if(n.size!==0){let e=await n.arrayBuffer();m.push(e);g.port1.postMessage(null)}}}else if(typeof r.data==="string"){if(u===-1){d+=r.data}else{g.port1.postMessage(null)}}};if((n==null?void 0:n.body)instanceof FormData){if(!n.headers){n.headers=new Headers}if(n.headers instanceof Headers){n.headers.append("Content-Type","multipart/form-data; boundary="+p)}else if(typeof n.headers==="object"){if(n.headers instanceof Array){n.headers.push(["Content-Type","multipart/form-data; boundary="+p])}else{n.headers["Content-Type"]="multipart/form-data; boundary="+p}}}s(r,e,n).then(()=>{a(r,n==null?void 0:n.body).catch(e=>{t(e)})}).catch(e=>{t(e)});return o}}var b=class{constructor(e,n){this.answered=false;this.connectionPromiseResolve=()=>{};this.onAnswer=n;this.peerConnection=new RTCPeerConnection({iceServers:[{urls:e}]});this.connectionPromise=new Promise((e,n)=>{this.connectionPromiseResolve=e});this._configurePeerConnection()}_configurePeerConnection(){const t=this.peerConnection;t.onicegatheringstatechange=e=>{console.log("onicegatheringstatechange",t.iceGatheringState);let n=e.target;if(n.iceGatheringState==="complete"&&n.localDescription){this.onAnswer(n.localDescription)}};t.ondatachannel=e=>{console.log("ondatachannel",e);window.fetch=o(e.channel);window.rtcReady=true;this.connectionPromiseResolve()};t.onnegotiationneeded=e=>{console.log("onnegotiationneeded")};t.onsignalingstatechange=e=>{console.log("onsignalingstatechange",t.signalingState)};t.oniceconnectionstatechange=e=>{console.log("oniceconnectionstatechange",t.iceConnectionState)}}async answerOffer(e){if(this.answered){return this.connectionPromise}const n=this.peerConnection;try{await n.setRemoteDescription(e);const t=await n.createAnswer();await n.setLocalDescription(t);this.answered=true}catch(e){console.error(e)}return this.connectionPromise}};var t="{{ .Offer }}";var i="{{ .SessionID }}";console.log(`session id: ${i}`);var T=parseInt(i);console.log(`session id number: ${T}`);function $(){var e,n,t;const o=(e=document.getElementById("ice-server-url"))==null?void 0:e.value;const r=(n=document.getElementById("server-sd"))==null?void 0:n.value;const s=r?JSON.parse(r):void 0;if(!s||!o){alert("missing server-sd or ice-url");return}const a=new b(o,e=>{const n=JSON.stringify(e);const t=document.getElementById("answer-container");console.log(`answer session description:
${n}`);if(t){t.innerText=n}navigator.clipboard.writeText(n)});const i=(t=document.getElementById("httpRequest"))==null?void 0:t.value;if(!i){alert("missing request");return}a.answerOffer(s).then(()=>{c("/",{})})}function C(){var e,n,t;const o=(e=document.getElementById("ice-server-url"))==null?void 0:e.value;const r=(n=document.getElementById("server-sd"))==null?void 0:n.value;const s=r?JSON.parse(r):void 0;if(!s||!o){alert("missing server-sd or ice-url");return}const a=new b(o,e=>{fetch("/api/sdp/answer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:T,answer:e.sdp})}).then(e=>{if(e.status!==200){alert("failed to send answer: "+e.status+" "+e.statusText)}}).catch(e=>{alert(`failed to send answer: ${e}`)})});const i=(t=document.getElementById("httpRequest"))==null?void 0:t.value;if(!i){alert("missing request");return}a.answerOffer(s).then(()=>{console.log("answer offer");c("/",{})})}var E=document.getElementById("httpRequest");if(E){const R={};R["User-Agent"]=navigator.userAgent;let e="";for(const x in R){e+=`${x}: ${R[x]}
`}if(e){e+="\n"}E.value=`GET / HTTP/1.1
${e}`}var P;if(12<t.length){console.log("offer is not default");const B=document.getElementById("server-sd");if(B){console.log("setting offer");B.innerText=t}C()}else{(P=document.getElementById("connect-button"))==null?void 0:P.addEventListener("click",$)}window.WebRTCClient=b})();
    </script>
</footer>
</html>